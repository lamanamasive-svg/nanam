name: RDP with Bore

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      shell: pwsh
      run: |
        # RDP servisini etkinleÅŸtir
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        
        # Windows Firewall'da RDP'ye izin ver
        Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
        
        # runneradmin kullanÄ±cÄ±sÄ± iÃ§in ÅŸifre belirle
        Set-LocalUser -Name 'runneradmin' -Password (ConvertTo-SecureString -AsPlainText 'Pass123!' -Force)
        
        Write-Host "RDP baÅŸarÄ±yla etkinleÅŸtirildi"

    - name: Download and Extract Bore
      shell: pwsh
      run: |
        # Bore'u indir
        Write-Host "Bore indiriliyor..."
        Invoke-WebRequest -Uri 'https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-pc-windows-msvc.zip' -OutFile bore.zip
        
        # ArÅŸivi Ã§Ä±kart
        Expand-Archive bore.zip -DestinationPath . -Force
        
        # bore.exe dosyasÄ±nÄ± bul ve ana dizine kopyala
        $exe = Get-ChildItem -Recurse -File -Filter 'bore.exe' | Select-Object -First 1
        if ($exe) { 
          Copy-Item $exe.FullName -Destination (Join-Path $PWD 'bore.exe') -Force 
          Write-Host "Bore baÅŸarÄ±yla indirildi ve hazÄ±rlandÄ±"
        } else {
          throw "bore.exe bulunamadÄ±"
        }

    - name: Start Bore Tunnel and Display Connection Info
      shell: pwsh
      run: |
        $outputFile = Join-Path $PWD 'bore_output.txt'
        
        # Ã–nceki Ã§Ä±ktÄ± dosyasÄ±nÄ± temizle
        if (Test-Path $outputFile) { Remove-Item $outputFile -Force }
        
        # Bore tÃ¼nelini baÅŸlat
        Write-Host "Bore tÃ¼neli baÅŸlatÄ±lÄ±yor..."
        $process = Start-Process -FilePath '.\bore.exe' -ArgumentList 'local 3389 --to bore.pub' -RedirectStandardOutput $outputFile -RedirectStandardError $outputFile -WindowStyle Hidden -PassThru
        
        # Port bilgisini yakala
        $port = $null
        $maxWaitTime = 120
        $startTime = Get-Date
        
        while (((Get-Date) - $startTime).TotalSeconds -lt $maxWaitTime) {
          if (Test-Path $outputFile) {
            $content = Get-Content $outputFile -Raw -ErrorAction SilentlyContinue
            
            # FarklÄ± port formatlarÄ±nÄ± kontrol et
            if ($content -match 'bore\.pub:(\d+)') { 
              $port = $matches[1]
              break 
            }
            if ($content -match 'remote port(?:\s+is|\s+assigned\s+as|\s+assigned|:)?\s*(\d+)') { 
              $port = $matches[1]
              break 
            }
            if ($content -match 'assigned port:?\s*(\d+)') { 
              $port = $matches[1]
              break 
            }
            if ($content -match 'listening on bore\.pub:(\d+)') { 
              $port = $matches[1]
              break 
            }
          }
          Start-Sleep -Seconds 2
        }
        
        # Port bulunamazsa hata ver
        if (-not $port) {
          Write-Host "HATA: Bore portu tespit edilemedi!"
          Write-Host "Bore Ã§Ä±ktÄ±sÄ±:"
          if (Test-Path $outputFile) { 
            Get-Content $outputFile | ForEach-Object { Write-Host $_ }
          }
          throw "Bore portu bulunamadÄ± - tÃ¼nel baÅŸlatÄ±lamadÄ±"
        }
        
        # BaÄŸlantÄ± bilgilerini gÃ¶ster
        $fullAddress = "bore.pub:$port"
        Write-Host ""
        Write-Host "=================================================="
        Write-Host "ğŸ”— RDP BAÄLANTI BÄ°LGÄ°LERÄ°"
        Write-Host "=================================================="
        Write-Host "ğŸ“ Host Adresi    : $fullAddress"
        Write-Host "ğŸ‘¤ KullanÄ±cÄ± AdÄ±  : runneradmin"
        Write-Host "ğŸ” Åifre          : Pass123!"
        Write-Host ""
        Write-Host "ğŸ–¥ï¸  REMMINA Ä°Ã‡Ä°N:"
        Write-Host "   â€¢ Protokol: RDP"
        Write-Host "   â€¢ Sunucu: $fullAddress"
        Write-Host "   â€¢ KullanÄ±cÄ±: runneradmin"
        Write-Host "   â€¢ Åifre: Pass123!"
        Write-Host "=================================================="
        Write-Host ""
        
        # TÃ¼nel durumunu kontrol et
        if ($process -and !$process.HasExited) {
          Write-Host "âœ… Bore tÃ¼neli baÅŸarÄ±yla Ã§alÄ±ÅŸÄ±yor (PID: $($process.Id))"
        } else {
          Write-Host "âš ï¸  Bore tÃ¼neli durumu belirsiz"
        }

    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "ğŸ• Oturum 6 saat boyunca aÃ§Ä±k tutulacak..."
        Write-Host "â° BaÅŸlangÄ±Ã§ zamanÄ±: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        
        # Her 30 dakikada bir durum mesajÄ± gÃ¶ster
        for ($i = 1; $i -le 720; $i++) {
          Start-Sleep -Seconds 30
          if ($i % 60 -eq 0) {
            $elapsed = $i / 2
            Write-Host "â±ï¸  GeÃ§en sÃ¼re: $elapsed dakika - Oturum hala aktif"
          }
        }
        
        Write-Host "â° Oturum sÃ¼resi doldu: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
