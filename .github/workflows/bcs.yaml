name: RDP with Bore

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      shell: pwsh
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
        Set-LocalUser -Name 'runneradmin' -Password (ConvertTo-SecureString -AsPlainText 'Pass123!' -Force)
        Write-Host "RDP ba≈üarƒ±yla etkinle≈ütirildi"

    - name: Configure RDP for Linux Clients
      shell: pwsh
      run: |
        # Linux RDP istemcileri i√ßin uyumluluk ayarlarƒ±
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'SecurityLayer' -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'fAllowSecProtocolNegotiation' -Value 0
        
        # RDP servisini yeniden ba≈ülat
        Restart-Service TermService -Force
        Write-Host "Linux uyumluluƒüu i√ßin RDP yapƒ±landƒ±rƒ±ldƒ±"

    - name: Download and Extract Bore
      shell: pwsh
      run: |
        Write-Host "Bore indiriliyor..."
        Invoke-WebRequest -Uri 'https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-pc-windows-msvc.zip' -OutFile bore.zip
        Expand-Archive bore.zip -DestinationPath ./bore_temp -Force
        
        $exe = Get-ChildItem -Path ./bore_temp -Recurse -File -Filter 'bore.exe' | Select-Object -First 1
        if ($exe) { 
          $targetPath = Join-Path $PWD 'bore.exe'
          if (Test-Path $targetPath) { Remove-Item $targetPath -Force }
          Copy-Item $exe.FullName -Destination $targetPath -Force 
          Write-Host "Bore ba≈üarƒ±yla hazƒ±rlandƒ±"
          Remove-Item ./bore_temp -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item bore.zip -Force -ErrorAction SilentlyContinue
        } else {
          throw "bore.exe bulunamadƒ±"
        }

    - name: Start Bore Tunnel and Display Connection Info
      shell: pwsh
      run: |
        $outputFile = Join-Path $PWD 'bore_output.txt'
        $errorFile = Join-Path $PWD 'bore_error.txt'
        
        if (Test-Path $outputFile) { Remove-Item $outputFile -Force }
        if (Test-Path $errorFile) { Remove-Item $errorFile -Force }
        
        Write-Host "Bore t√ºneli ba≈ülatƒ±lƒ±yor..."
        $process = Start-Process -FilePath '.\bore.exe' -ArgumentList 'local 3389 --to bore.pub' -RedirectStandardOutput $outputFile -RedirectStandardError $errorFile -WindowStyle Hidden -PassThru
        
        $port = $null
        $maxWaitTime = 120
        $startTime = Get-Date
        
        while (((Get-Date) - $startTime).TotalSeconds -lt $maxWaitTime) {
          $content = ""
          if (Test-Path $outputFile) {
            $content += Get-Content $outputFile -Raw -ErrorAction SilentlyContinue
          }
          if (Test-Path $errorFile) {
            $content += Get-Content $errorFile -Raw -ErrorAction SilentlyContinue
          }
          
          if ($content) {
            if ($content -match 'bore\.pub:(\d+)') { 
              $port = $matches[1]; break 
            }
            if ($content -match 'remote port(?:\s+is|\s+assigned\s+as|\s+assigned|:)?\s*(\d+)') { 
              $port = $matches[1]; break 
            }
          }
          Start-Sleep -Seconds 2
        }
        
        if (-not $port) {
          Write-Host "HATA: Bore portu tespit edilemedi!"
          throw "Bore portu bulunamadƒ±"
        }
        
        $fullAddress = "bore.pub:$port"
        Write-Host ""
        Write-Host "=================================================="
        Write-Host "üîó RDP BAƒûLANTI Bƒ∞LGƒ∞LERƒ∞"
        Write-Host "=================================================="
        Write-Host "üìç Host: $fullAddress"
        Write-Host "üë§ User: runneradmin"
        Write-Host "üîê Pass: Pass123!"
        Write-Host ""
        Write-Host "üñ•Ô∏è  REMMINA AYARLARI:"
        Write-Host "   ‚Ä¢ Protokol: RDP"
        Write-Host "   ‚Ä¢ Sunucu: $fullAddress"
        Write-Host "   ‚Ä¢ G√ºvenlik: RDP veya Any"
        Write-Host "   ‚Ä¢ Disable encryption: ‚úì"
        Write-Host "   ‚Ä¢ Ignore certificate: ‚úì"
        Write-Host ""
        Write-Host "üîß ALTERNATIF KOMUT:"
        Write-Host "   xfreerdp /v:$fullAddress /u:runneradmin /p:Pass123! /cert-ignore /sec:rdp"
        Write-Host "=================================================="

    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "üïê Oturum 6 saat a√ßƒ±k kalacak..."
        Start-Sleep -Seconds 21600
