name: Windows

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
          Set-LocalUser -Name 'runneradmin' -Password (ConvertTo-SecureString -AsPlainText 'Pass123!' -Force)
          Write-Host "âœ… RDP etkinleÅŸtirildi"

      - name: Download Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ“¥ Ngrok indiriliyor..."
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath . -Force
          Remove-Item ngrok.zip -Force
          Write-Host "âœ… Ngrok hazÄ±rlandÄ±"

      - name: Configure Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ”‘ Ngrok yapÄ±landÄ±rÄ±lÄ±yor..."
          & .\ngrok.exe config add-authtoken "2h77XN9Ic3xIZXMxvCkkVigsbqm_6ZHkqfguxg8V1GoGe7WuP"
          Write-Host "âœ… Auth token yapÄ±landÄ±rÄ±ldÄ±"

      - name: Start Ngrok and Display Connection
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Ngrok baÅŸlatÄ±lÄ±yor..."
          
          # Ngrok'u baÅŸlat ve Ã§Ä±ktÄ±yÄ± dosyaya yaz
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -RedirectStandardOutput "ngrok.txt" -WindowStyle Hidden
          
          # Ngrok'un baÅŸlamasÄ± iÃ§in bekle
          Start-Sleep -Seconds 15
          
          # Ã‡Ä±ktÄ±yÄ± oku
          if (Test-Path "ngrok.txt") {
            $ngrokOutput = Get-Content "ngrok.txt" -Raw
            Write-Host "Ngrok Ã§Ä±ktÄ±sÄ±:"
            Write-Host $ngrokOutput
          }
          
          # Alternatif yÃ¶ntem: Ngrok API'yi dene
          Write-Host ""
          Write-Host "ğŸ” BaÄŸlantÄ± bilgileri alÄ±nÄ±yor..."
          Start-Sleep -Seconds 5
          
          try {
            # Ngrok web arayÃ¼zÃ¼nden bilgi al
            $response = Invoke-WebRequest -Uri "http://localhost:4040/status" -UseBasicParsing -TimeoutSec 10
            Write-Host "Ngrok Status:"
            Write-Host $response.Content
            
            # API'den tunnel bilgisini al
            $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 10
            if ($tunnels.tunnels) {
              $tunnel = $tunnels.tunnels[0]
              $url = $tunnel.public_url
              
              # TCP URL'ini parse et
              if ($url -match "tcp://(.+):(\d+)") {
                $host = $matches[1]
                $port = $matches[2]
                
                Write-Host ""
                Write-Host "=================================================="
                Write-Host "ğŸ–¥ï¸ RDP BAÄLANTI BÄ°LGÄ°LERÄ°"
                Write-Host "=================================================="
                Write-Host "ğŸ“ Host: $host"
                Write-Host "ğŸ”Œ Port: $port"
                Write-Host "ğŸ‘¤ KullanÄ±cÄ±: runneradmin"
                Write-Host "ğŸ” Åifre: Pass123!"
                Write-Host ""
                Write-Host "ğŸ”§ BAÄLANTI KOMUTLARI:"
                Write-Host "   mstsc /v:$host`:$port"
                Write-Host "   xfreerdp /v:$host`:$port /u:runneradmin /p:Pass123! /cert-ignore"
                Write-Host "   rdesktop -u runneradmin -p Pass123! $host`:$port"
                Write-Host "=================================================="
              }
            }
          } catch {
            Write-Host "âš ï¸ Otomatik bilgi alÄ±namadÄ±. Manuel kontrol:"
            Write-Host ""
            Write-Host "1. TarayÄ±cÄ±da aÃ§Ä±n: http://localhost:4040"
            Write-Host "2. GÃ¶sterilen tcp://xxx.ngrok.io:PORT adresini kullanÄ±n"
            Write-Host ""
            Write-Host "RDP Bilgileri:"
            Write-Host "KullanÄ±cÄ±: runneradmin"
            Write-Host "Åifre: Pass123!"
          }
          
          # Son Ã§are: Process Ã§Ä±ktÄ±sÄ±nÄ± kontrol et
          Write-Host ""
          Write-Host "ğŸ“‹ Ngrok Process KontrolÃ¼:"
          Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Format-Table Id, ProcessName, StartTime
          
          # Alternatif log konumu
          $ngrokLog = "$env:LOCALAPPDATA\ngrok\ngrok.log"
          if (Test-Path $ngrokLog) {
            Write-Host ""
            Write-Host "ğŸ“„ Ngrok Log (son 20 satÄ±r):"
            Get-Content $ngrokLog -Tail 20
          }

      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "ğŸ• Oturum 6 saat aÃ§Ä±k kalacak..."
          Write-Host ""
          Write-Host "â„¹ï¸ SORUN GÄ°DERME:"
          Write-Host "1. Workflow Ã§Ä±ktÄ±sÄ±nda tcp://xxx.ngrok.io:PORT formatÄ±nda bir adres arayÄ±n"
          Write-Host "2. Bu adresi RDP istemcinizde kullanÄ±n"
          Write-Host "3. KullanÄ±cÄ±: runneradmin, Åifre: Pass123!"
          Write-Host ""
          
          # Her 30 dakikada durum kontrolÃ¼
          $startTime = Get-Date
          while ((Get-Date) -lt $startTime.AddHours(6)) {
            # Ngrok durumunu kontrol et
            try {
              $status = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 5 -ErrorAction SilentlyContinue
              if ($status.tunnels) {
                $tunnel = $status.tunnels[0]
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] âœ… Ngrok aktif: $($tunnel.public_url)"
              }
            } catch {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] âš ï¸ Ngrok durumu kontrol edilemiyor"
            }
            
            # 30 dakika bekle
            Start-Sleep -Seconds 1800
          }
