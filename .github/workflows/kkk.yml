name: RDP with Ngrok

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
          Set-LocalUser -Name 'runneradmin' -Password (ConvertTo-SecureString -AsPlainText 'Pass123!' -Force)
          Write-Host "âœ… RDP etkinleÅŸtirildi"

      - name: Configure RDP Compatibility
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'SecurityLayer' -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -Value 0
          Restart-Service TermService -Force
          Write-Host "âœ… RDP uyumluluk ayarlarÄ± yapÄ±ldÄ±"

      - name: Download and Setup Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ“¥ Ngrok indiriliyor..."
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath . -Force
          Write-Host "âœ… Ngrok hazÄ±rlandÄ±"

      - name: Start Ngrok Tunnel
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Ngrok tÃ¼neli baÅŸlatÄ±lÄ±yor..."
          
          # Ngrok'u arka planda baÅŸlat
          $job = Start-Job -ScriptBlock {
            & .\ngrok.exe tcp 3389 --log stdout
          }
          
          # 15 saniye bekle
          Start-Sleep -Seconds 15
          
          # Ngrok API'sinden tunnel bilgisini al
          try {
            $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -Method Get
            $tunnel = $response.tunnels | Where-Object { $_.proto -eq "tcp" } | Select-Object -First 1
            
            if ($tunnel) {
              $publicUrl = $tunnel.public_url
              $host = $publicUrl -replace "tcp://", ""
              
              Write-Host ""
              Write-Host "=================================================="
              Write-Host "ğŸ”— RDP BAÄLANTI BÄ°LGÄ°LERÄ°"
              Write-Host "=================================================="
              Write-Host "ğŸ“ Host: $host"
              Write-Host "ğŸ‘¤ User: runneradmin"
              Write-Host "ğŸ” Pass: Pass123!"
              Write-Host ""
              Write-Host "ğŸ–¥ï¸ REMMINA AYARLARI:"
              Write-Host "   â€¢ Protokol: RDP"
              Write-Host "   â€¢ Sunucu: $host"
              Write-Host "   â€¢ KullanÄ±cÄ±: runneradmin"
              Write-Host "   â€¢ Åifre: Pass123!"
              Write-Host ""
              Write-Host "ğŸ”§ XFREERDP KOMUTU:"
              Write-Host "   xfreerdp /v:$host /u:runneradmin /p:Pass123! /cert-ignore"
              Write-Host "=================================================="
            } else {
              Write-Host "âŒ Tunnel bilgisi alÄ±namadÄ±"
            }
          } catch {
            Write-Host "âŒ Ngrok API hatasÄ±: $($_.Exception.Message)"
          }

      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "ğŸ• Oturum 6 saat aÃ§Ä±k kalacak..."
          Start-Sleep -Seconds 21600
