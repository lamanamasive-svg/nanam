name: Windows RDP with Ngrok Auth

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
          Set-LocalUser -Name 'runneradmin' -Password (ConvertTo-SecureString -AsPlainText 'Pass123!' -Force)
          Write-Host "âœ… RDP etkinleÅŸtirildi"

      - name: Configure RDP for Better Compatibility
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'SecurityLayer' -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'fAllowSecProtocolNegotiation' -Value 0
          Restart-Service TermService -Force
          Write-Host "âœ… RDP uyumluluk ayarlarÄ± yapÄ±ldÄ±"

      - name: Download and Setup Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ“¥ Ngrok indiriliyor..."
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath . -Force
          Remove-Item ngrok.zip -Force
          Write-Host "âœ… Ngrok hazÄ±rlandÄ±"

      - name: Configure Ngrok Auth Token
        shell: pwsh
        run: |
          Write-Host "ğŸ”‘ Ngrok auth token yapÄ±landÄ±rÄ±lÄ±yor..."
          & .\ngrok.exe config add-authtoken "2h77XN9Ic3xIZXMxvCkkVigsbqm_6ZHkqfguxg8V1GoGe7WuP"
          Write-Host "âœ… Auth token yapÄ±landÄ±rÄ±ldÄ±"

      - name: Start Ngrok Tunnel and Show Connection Info
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Ngrok TCP tÃ¼neli baÅŸlatÄ±lÄ±yor..."
          
          # Ngrok'u arka planda baÅŸlat
          $job = Start-Job -ScriptBlock {
            & .\ngrok.exe tcp 3389 --log stdout
          }
          
          # 25 saniye bekle
          Start-Sleep -Seconds 25
          
          # Tunnel bilgisini al
          $tunnelFound = $false
          for ($i = 1; $i -le 15; $i++) {
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -Method Get -TimeoutSec 5
              
              if ($response.tunnels -and $response.tunnels.Count -gt 0) {
                $tunnel = $response.tunnels | Where-Object { $_.proto -eq "tcp" } | Select-Object -First 1
                
                if ($tunnel -and $tunnel.public_url) {
                  $publicUrl = $tunnel.public_url
                  $parts = $publicUrl -replace "tcp://", "" -split ":"
                  $host = $parts[0]
                  $port = $parts[1]
                  
                  Write-Host ""
                  Write-Host "=================================================="
                  Write-Host "ğŸ–¥ï¸ WINDOWS RDP BAÄLANTI BÄ°LGÄ°LERÄ°"
                  Write-Host "=================================================="
                  Write-Host "ğŸ“ Host: $host"
                  Write-Host "ğŸ”Œ Port: $port"
                  Write-Host "ğŸ‘¤ KullanÄ±cÄ±: runneradmin"
                  Write-Host "ğŸ” Åifre: Pass123!"
                  Write-Host ""
                  Write-Host "ğŸ–¥ï¸ REMMINA AYARLARI:"
                  Write-Host "   â€¢ Protokol: RDP"
                  Write-Host "   â€¢ Sunucu: $host"
                  Write-Host "   â€¢ Port: $port"
                  Write-Host "   â€¢ KullanÄ±cÄ±: runneradmin"
                  Write-Host "   â€¢ Åifre: Pass123!"
                  Write-Host "   â€¢ GÃ¼venlik: RDP"
                  Write-Host "   â€¢ Disable encryption: âœ“"
                  Write-Host "   â€¢ Ignore certificate: âœ“"
                  Write-Host ""
                  Write-Host "ğŸ”§ LINUX KOMUTLARI:"
                  Write-Host "   xfreerdp /v:$host`:$port /u:runneradmin /p:Pass123! /cert-ignore /sec:rdp"
                  Write-Host "   rdesktop -u runneradmin -p Pass123! $host`:$port"
                  Write-Host ""
                  Write-Host "ğŸ“± WINDOWS/MAC/MOBILE:"
                  Write-Host "   Microsoft Remote Desktop uygulamasÄ±nÄ± kullanÄ±n"
                  Write-Host ""
                  Write-Host "ğŸ” BAÄLANTI TESTÄ°:"
                  Write-Host "   telnet $host $port"
                  Write-Host "=================================================="
                  
                  # BaÄŸlantÄ± testi
                  Write-Host ""
                  Write-Host "ğŸ” Port eriÅŸilebilirlik testi yapÄ±lÄ±yor..."
                  try {
                    $tcpClient = New-Object System.Net.Sockets.TcpClient
                    $connect = $tcpClient.BeginConnect($host, $port, $null, $null)
                    $wait = $connect.AsyncWaitHandle.WaitOne(5000, $false)
                    
                    if ($wait -and $tcpClient.Connected) {
                      Write-Host "âœ… Port $port eriÅŸilebilir - RDP baÄŸlantÄ±sÄ± hazÄ±r!"
                      $tcpClient.Close()
                    } else {
                      Write-Host "âš ï¸ Port eriÅŸim testi baÅŸarÄ±sÄ±z"
                      $tcpClient.Close()
                    }
                  } catch {
                    Write-Host "âš ï¸ BaÄŸlantÄ± testi hatasÄ±: $($_.Exception.Message)"
                  }
                  
                  $tunnelFound = $true
                  break
                }
              }
            } catch {
              Write-Host "API denemesi $i baÅŸarÄ±sÄ±z, tekrar deneniyor..."
            }
            
            Start-Sleep -Seconds 3
          }
          
          if (-not $tunnelFound) {
            Write-Host "âŒ Tunnel bilgisi alÄ±namadÄ±. Job Ã§Ä±ktÄ±sÄ±nÄ± kontrol ediliyor..."
            $jobOutput = Receive-Job -Job $job -Keep
            if ($jobOutput) {
              Write-Host "=== NGROK Ã‡IKTISI ==="
              $jobOutput | ForEach-Object { Write-Host $_ }
              Write-Host "===================="
            }
            Write-Host ""
            Write-Host "ğŸŒ Manuel kontrol iÃ§in Ngrok web arayÃ¼zÃ¼: http://localhost:4040"
          }

      - name: Keep Session Alive with Monitoring
        shell: pwsh
        run: |
          Write-Host "ğŸ• Oturum 6 saat boyunca aÃ§Ä±k tutulacak..."
          Write-Host "â° BaÅŸlangÄ±Ã§: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          
          # Her 30 dakikada durum kontrolÃ¼
          for ($i = 1; $i -le 720; $i++) {
            Start-Sleep -Seconds 30
            
            if ($i % 60 -eq 0) {  # Her 30 dakikada
              $elapsed = $i / 2
              Write-Host "â±ï¸ GeÃ§en sÃ¼re: $elapsed dakika - RDP aktif"
              
              # Ngrok durumunu kontrol et
              try {
                $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -Method Get -TimeoutSec 3 -ErrorAction SilentlyContinue
                if ($response -and $response.tunnels) {
                  $tunnel = $response.tunnels | Where-Object { $_.proto -eq "tcp" } | Select-Object -First 1
                  if ($tunnel) {
                    $publicUrl = $tunnel.public_url -replace "tcp://", ""
                    Write-Host "ğŸ“ RDP adresi: $publicUrl"
                    Write-Host "ğŸŒ Web panel: http://localhost:4040"
                  }
                }
              } catch {
                Write-Host "âš ï¸ Ngrok durumu kontrol edilemiyor"
              }
            }
          }
          
          Write-Host "â° Oturum sÃ¼resi doldu: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
