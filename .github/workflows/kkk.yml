name: Windows RDP with Ngrok

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
          Set-LocalUser -Name 'runneradmin' -Password (ConvertTo-SecureString -AsPlainText 'Pass123!' -Force)
          Write-Host "âœ… RDP etkinleÅŸtirildi"

      - name: Download Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ“¥ Ngrok indiriliyor..."
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath . -Force
          Remove-Item ngrok.zip -Force
          Write-Host "âœ… Ngrok hazÄ±rlandÄ±"

      - name: Configure Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ”‘ Ngrok yapÄ±landÄ±rÄ±lÄ±yor..."
          & .\ngrok.exe config add-authtoken "2h77XN9Ic3xIZXMxvCkkVigsbqm_6ZHkqfguxg8V1GoGe7WuP"
          Write-Host "âœ… Auth token yapÄ±landÄ±rÄ±ldÄ±"

      - name: Start Ngrok and Display Connection
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Ngrok baÅŸlatÄ±lÄ±yor..."
          
          # Ngrok'u baÅŸlat ve Ã§Ä±ktÄ±yÄ± yakala
          $process = Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -PassThru -RedirectStandardOutput "ngrok_output.txt" -RedirectStandardError "ngrok_error.txt" -WindowStyle Hidden
          
          Write-Host "â³ Ngrok baÅŸlatÄ±lÄ±yor, lÃ¼tfen bekleyin..."
          Start-Sleep -Seconds 20
          
          # Ã‡Ä±ktÄ±yÄ± kontrol et
          if (Test-Path "ngrok_output.txt") {
            $output = Get-Content "ngrok_output.txt" -Raw
            
            # URL'i parse et - dÃ¼zeltilmiÅŸ regex
            if ($output -match 'url=tcp://([^:]+):(\d+)') {
              $ngrokHost = $matches[1]
              $ngrokPort = $matches[2]
              
              Write-Host ""
              Write-Host "=================================================="
              Write-Host "ğŸ–¥ï¸ RDP BAÄLANTI BÄ°LGÄ°LERÄ°"
              Write-Host "=================================================="
              Write-Host "ğŸ“ Host: $ngrokHost"
              Write-Host "ğŸ”Œ Port: $ngrokPort"
              Write-Host "ğŸ‘¤ KullanÄ±cÄ±: runneradmin"
              Write-Host "ğŸ” Åifre: Pass123!"
              Write-Host ""
              Write-Host "ğŸ”§ WINDOWS RDP:"
              Write-Host "   mstsc /v:${ngrokHost}:${ngrokPort}"
              Write-Host ""
              Write-Host "ğŸ§ LINUX (Remmina):"
              Write-Host "   Protokol: RDP"
              Write-Host "   Sunucu: $ngrokHost"
              Write-Host "   Port: $ngrokPort"
              Write-Host "   KullanÄ±cÄ±: runneradmin"
              Write-Host "   Åifre: Pass123!"
              Write-Host ""
              Write-Host "ğŸ”§ LINUX (Terminal):"
              Write-Host "   xfreerdp /v:${ngrokHost}:${ngrokPort} /u:runneradmin /p:Pass123! /cert-ignore /sec:rdp"
              Write-Host "   rdesktop -u runneradmin -p Pass123! ${ngrokHost}:${ngrokPort}"
              Write-Host ""
              Write-Host "ğŸ“± MOBÄ°L/TABLET:"
              Write-Host "   Microsoft Remote Desktop uygulamasÄ±nÄ± kullanÄ±n"
              Write-Host "   PC adÄ±: ${ngrokHost}:${ngrokPort}"
              Write-Host "=================================================="
              
              # GitHub Summary'e ekle
              @"
              ## ğŸ–¥ï¸ RDP BaÄŸlantÄ± Bilgileri
              
              **Host:** ``$ngrokHost``  
              **Port:** ``$ngrokPort``  
              **KullanÄ±cÄ±:** ``runneradmin``  
              **Åifre:** ``Pass123!``
              
              ### BaÄŸlantÄ± KomutlarÄ±:
              
              **Windows:**
              ```
              mstsc /v:${ngrokHost}:${ngrokPort}
              ```
              
              **Linux:**
              ```
              xfreerdp /v:${ngrokHost}:${ngrokPort} /u:runneradmin /p:Pass123! /cert-ignore
              ```
              "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8
              
            } else {
              Write-Host "âš ï¸ URL parse edilemedi. Ngrok Ã§Ä±ktÄ±sÄ±:"
              Write-Host $output
            }
          }

      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "ğŸ• Oturum 6 saat boyunca aÃ§Ä±k tutulacak..."
          Write-Host "â° BaÅŸlangÄ±Ã§: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          
          # Her 30 dakikada bir kontrol
          for ($i = 1; $i -le 720; $i++) {
            Start-Sleep -Seconds 30
            
            if ($i % 60 -eq 0) {
              $elapsed = $i / 2
              Write-Host "â±ï¸ GeÃ§en sÃ¼re: $elapsed dakika - RDP aktif"
              
              # Process kontrolÃ¼
              $ngrokProcess = Get-Process -Name "ngrok" -ErrorAction SilentlyContinue
              if ($ngrokProcess) {
                Write-Host "âœ… Ngrok Ã§alÄ±ÅŸÄ±yor (PID: $($ngrokProcess.Id))"
              } else {
                Write-Host "âŒ Ngrok process bulunamadÄ±!"
              }
            }
          }
          
          Write-Host "â° Oturum sÃ¼resi doldu: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
