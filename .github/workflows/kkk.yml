name: Windows RDP with Ngrok Direct

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
          Set-LocalUser -Name 'runneradmin' -Password (ConvertTo-SecureString -AsPlainText 'Pass123!' -Force)
          Write-Host "âœ… RDP etkinleÅŸtirildi"

      - name: Download Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ“¥ Ngrok indiriliyor..."
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath . -Force
          Remove-Item ngrok.zip -Force
          Write-Host "âœ… Ngrok hazÄ±rlandÄ±"

      - name: Configure Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ”‘ Ngrok yapÄ±landÄ±rÄ±lÄ±yor..."
          & .\ngrok.exe config add-authtoken "2h77XN9Ic3xIZXMxvCkkVigsbqm_6ZHkqfguxg8V1GoGe7WuP"
          Write-Host "âœ… Auth token yapÄ±landÄ±rÄ±ldÄ±"

      - name: Start Ngrok with Direct Output
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Ngrok baÅŸlatÄ±lÄ±yor ve baÄŸlantÄ± bilgisi alÄ±nÄ±yor..."
          
          # Ngrok'u arka planda baÅŸlat ve Ã§Ä±ktÄ±yÄ± yakala
          $process = Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -PassThru -RedirectStandardOutput "ngrok_output.txt" -RedirectStandardError "ngrok_error.txt" -WindowStyle Hidden
          
          Write-Host "â³ Ngrok baÅŸlatÄ±lÄ±yor, lÃ¼tfen bekleyin..."
          Start-Sleep -Seconds 30
          
          # Ã‡Ä±ktÄ±yÄ± kontrol et
          Write-Host ""
          Write-Host "ğŸ“„ Ngrok Ã‡Ä±ktÄ±sÄ±:"
          if (Test-Path "ngrok_output.txt") {
            $output = Get-Content "ngrok_output.txt" -Raw
            Write-Host $output
            
            # URL'i parse et
            if ($output -match 'url=tcp://([^:]+):(\d+)') {
              $host = $matches[1]
              $port = $matches[2]
              
              Write-Host ""
              Write-Host "=================================================="
              Write-Host "ğŸ–¥ï¸ RDP BAÄLANTI BÄ°LGÄ°LERÄ°"
              Write-Host "=================================================="
              Write-Host "ğŸ“ Host: $host"
              Write-Host "ğŸ”Œ Port: $port"
              Write-Host "ğŸ‘¤ KullanÄ±cÄ±: runneradmin"
              Write-Host "ğŸ” Åifre: Pass123!"
              Write-Host ""
              Write-Host "ğŸ”§ BAÄLANTI KOMUTLARI:"
              Write-Host "   mstsc /v:$host`:$port"
              Write-Host "   xfreerdp /v:$host`:$port /u:runneradmin /p:Pass123! /cert-ignore"
              Write-Host "   rdesktop -u runneradmin -p Pass123! $host`:$port"
              Write-Host "=================================================="
            }
          }
          
          # Error Ã§Ä±ktÄ±sÄ±nÄ± kontrol et
          if (Test-Path "ngrok_error.txt") {
            $error_content = Get-Content "ngrok_error.txt" -Raw
            if ($error_content) {
              Write-Host ""
              Write-Host "ğŸ“› Ngrok Error:"
              Write-Host $error_content
            }
          }
          
          # Alternatif: API'yi tekrar dene (daha uzun bekleme ile)
          Write-Host ""
          Write-Host "ğŸ” API Ã¼zerinden kontrol ediliyor..."
          Start-Sleep -Seconds 10
          
          $maxRetries = 5
          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 10
              if ($response.tunnels -and $response.tunnels.Count -gt 0) {
                $tunnel = $response.tunnels[0]
                $url = $tunnel.public_url
                
                if ($url -match "tcp://(.+):(\d+)") {
                  $host = $matches[1]
                  $port = $matches[2]
                  
                  Write-Host ""
                  Write-Host "âœ… API'den alÄ±nan baÄŸlantÄ± bilgileri:"
                  Write-Host "Host: $host"
                  Write-Host "Port: $port"
                  break
                }
              }
            } catch {
              Write-Host "API denemesi $i/$maxRetries baÅŸarÄ±sÄ±z"
              if ($i -lt $maxRetries) {
                Start-Sleep -Seconds 5
              }
            }
          }
          
          # Son kontrol: Process Ã§alÄ±ÅŸÄ±yor mu?
          Write-Host ""
          Write-Host "ğŸ“Š Ngrok Process Durumu:"
          $ngrokProcess = Get-Process -Name "ngrok" -ErrorAction SilentlyContinue
          if ($ngrokProcess) {
            Write-Host "âœ… Ngrok Ã§alÄ±ÅŸÄ±yor (PID: $($ngrokProcess.Id))"
          } else {
            Write-Host "âŒ Ngrok process bulunamadÄ±!"
          }

      - name: Alternative - Try Ngrok HTTP Inspect
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "ğŸŒ Ngrok Web ArayÃ¼zÃ¼ Bilgileri:"
          Write-Host "TarayÄ±cÄ±da aÃ§Ä±n: http://localhost:4040"
          Write-Host "Status sayfasÄ±: http://localhost:4040/status"
          Write-Host "Inspect sayfasÄ±: http://localhost:4040/inspect/http"
          Write-Host ""
          
          # Web sayfasÄ±ndan bilgi almayÄ± dene
          try {
            $webContent = Invoke-WebRequest -Uri "http://localhost:4040" -UseBasicParsing -TimeoutSec 10
            if ($webContent.Content -match 'tcp://([a-zA-Z0-9.-]+\.(tcp\.)?ngrok[.-][a-zA-Z0-9.-]+):(\d+)') {
              Write-Host "âœ… Web sayfasÄ±ndan bulunan URL: $($matches[0])"
            }
          } catch {
            Write-Host "Web sayfasÄ± okunamadÄ±"
          }

      - name: Display Final Instructions
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "=================================================="
          Write-Host "ğŸ“‹ Ã–ZET"
          Write-Host "=================================================="
          Write-Host "1. YukarÄ±daki Ã§Ä±ktÄ±larda tcp://xxx.ngrok.io:PORT"
          Write-Host "   formatÄ±nda bir adres arayÄ±n"
          Write-Host ""
          Write-Host "2. RDP baÄŸlantÄ±sÄ± iÃ§in:"
          Write-Host "   â€¢ Host: xxx.ngrok.io"
          Write-Host "   â€¢ Port: gÃ¶sterilen port numarasÄ±"
          Write-Host "   â€¢ KullanÄ±cÄ±: runneradmin"
          Write-Host "   â€¢ Åifre: Pass123!"
          Write-Host ""
          Write-Host "3. EÄŸer URL bulunamazsa:"
          Write-Host "   â€¢ http://localhost:4040 adresini kontrol edin"
          Write-Host "   â€¢ Veya ngrok_output.txt dosyasÄ±nÄ± inceleyin"
          Write-Host "=================================================="

      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "ğŸ• Oturum 6 saat aÃ§Ä±k kalacak..."
          
          # Ä°lk 5 dakika boyunca her dakika kontrol et
          for ($i = 1; $i -le 5; $i++) {
            Start-Sleep -Seconds 60
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Kontrol $i/5..."
            
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 5 -ErrorAction SilentlyContinue
              if ($response.tunnels -and $response.tunnels.Count -gt 0) {
                $tunnel = $response.tunnels[0]
                Write-Host "âœ… Ngrok aktif: $($tunnel.public_url)"
                break
              }
            } catch {
              Write-Host "API hala hazÄ±r deÄŸil..."
            }
          }
          
          # Kalan sÃ¼re iÃ§in 30 dakikada bir kontrol
          $endTime = (Get-Date).AddHours(6)
          while ((Get-Date) -lt $endTime) {
            Start-Sleep -Seconds 1800
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Sistem aktif"
          }
