name: RDP with Cloudflare Tunnel

on:
  workflow_dispatch:
    inputs:
      cloudflare_token:
        description: 'Cloudflare API Token'
        required: true
        type: string

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
          Set-LocalUser -Name 'runneradmin' -Password (ConvertTo-SecureString -AsPlainText 'Pass123!' -Force)
          Write-Host "âœ… RDP etkinleÅŸtirildi"

      - name: Configure RDP for Better Compatibility
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'SecurityLayer' -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'fAllowSecProtocolNegotiation' -Value 0
          Restart-Service TermService -Force
          Write-Host "âœ… RDP uyumluluk ayarlarÄ± yapÄ±ldÄ±"

      - name: Download and Install Cloudflared
        shell: pwsh
        run: |
          Write-Host "ğŸ“¥ Cloudflared indiriliyor..."
          $url = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
          Invoke-WebRequest -Uri $url -OutFile "cloudflared.exe"
          
          # Cloudflared versiyonunu kontrol et
          $version = & .\cloudflared.exe --version
          Write-Host "âœ… Cloudflared yÃ¼klendi: $version"

      - name: Create Cloudflare Tunnel
        shell: pwsh
        env:
          CLOUDFLARE_API_TOKEN: ${{ github.event.inputs.cloudflare_token }}
        run: |
          Write-Host "ğŸ”§ Cloudflare Tunnel oluÅŸturuluyor..."
          
          # Tunnel oluÅŸtur
          $tunnelName = "github-rdp-$(Get-Random -Minimum 1000 -Maximum 9999)"
          Write-Host "Tunnel adÄ±: $tunnelName"
          
          $createOutput = & .\cloudflared.exe tunnel create $tunnelName 2>&1
          Write-Host "Tunnel oluÅŸturma Ã§Ä±ktÄ±sÄ±:"
          $createOutput | ForEach-Object { Write-Host $_ }
          
          # Tunnel ID'sini Ã§Ä±kar
          $tunnelId = $null
          foreach ($line in $createOutput) {
            if ($line -match 'Created tunnel .* with id ([a-f0-9-]+)') {
              $tunnelId = $matches[1]
              break
            }
          }
          
          if (-not $tunnelId) {
            throw "Tunnel ID bulunamadÄ±. Ã‡Ä±ktÄ±: $($createOutput -join "`n")"
          }
          
          Write-Host "âœ… Tunnel ID: $tunnelId"
          
          # Config dosyasÄ± oluÅŸtur
          $configContent = @"
          tunnel: $tunnelId
          credentials-file: $env:USERPROFILE\.cloudflared\$tunnelId.json

          ingress:
            - hostname: $tunnelName.trycloudflare.com
              service: rdp://localhost:3389
            - service: http_status:404
          "@
          
          $configDir = "$env:USERPROFILE\.cloudflared"
          if (-not (Test-Path $configDir)) {
            New-Item -ItemType Directory -Path $configDir -Force
          }
          
          $configPath = "$configDir\config.yml"
          $configContent | Out-File -FilePath $configPath -Encoding UTF8
          Write-Host "âœ… Config dosyasÄ± oluÅŸturuldu: $configPath"
          
          # Tunnel'Ä± DNS'e route et
          Write-Host "ğŸŒ DNS routing yapÄ±lÄ±yor..."
          $routeOutput = & .\cloudflared.exe tunnel route dns $tunnelId $tunnelName.trycloudflare.com 2>&1
          $routeOutput | ForEach-Object { Write-Host $_ }
          
          # Global deÄŸiÅŸken olarak kaydet
          echo "TUNNEL_NAME=$tunnelName" >> $env:GITHUB_ENV
          echo "TUNNEL_ID=$tunnelId" >> $env:GITHUB_ENV

      - name: Start Cloudflare Tunnel
        shell: pwsh
        env:
          CLOUDFLARE_API_TOKEN: ${{ github.event.inputs.cloudflare_token }}
        run: |
          Write-Host "ğŸš€ Cloudflare Tunnel baÅŸlatÄ±lÄ±yor..."
          
          $tunnelName = $env:TUNNEL_NAME
          $configPath = "$env:USERPROFILE\.cloudflared\config.yml"
          
          # Tunnel'Ä± arka planda baÅŸlat
          $job = Start-Job -ScriptBlock {
            param($cloudflaredPath, $configPath)
            & $cloudflaredPath tunnel --config $configPath run 2>&1
          } -ArgumentList (Resolve-Path .\cloudflared.exe), $configPath
          
          # 30 saniye bekle ve durumu kontrol et
          Start-Sleep -Seconds 30
          
          $output = Receive-Job -Job $job -Keep
          if ($output) {
            Write-Host "=== CLOUDFLARE TUNNEL Ã‡IKTISI ==="
            $output | ForEach-Object { Write-Host $_ }
            Write-Host "================================"
          }
          
          # BaÄŸlantÄ± bilgilerini gÃ¶ster
          $rdpAddress = "$tunnelName.trycloudflare.com"
          Write-Host ""
          Write-Host "=================================================="
          Write-Host "ğŸ”— RDP BAÄLANTI BÄ°LGÄ°LERÄ°"
          Write-Host "=================================================="
          Write-Host "ğŸ“ Host: $rdpAddress"
          Write-Host "ğŸ‘¤ User: runneradmin"
          Write-Host "ğŸ” Pass: Pass123!"
          Write-Host "ğŸ”Œ Port: 3389 (varsayÄ±lan)"
          Write-Host ""
          Write-Host "ğŸ–¥ï¸ REMMINA AYARLARI:"
          Write-Host "   â€¢ Protokol: RDP"
          Write-Host "   â€¢ Sunucu: $rdpAddress"
          Write-Host "   â€¢ Port: 3389"
          Write-Host "   â€¢ KullanÄ±cÄ±: runneradmin"
          Write-Host "   â€¢ Åifre: Pass123!"
          Write-Host ""
          Write-Host "ğŸ”§ XFREERDP KOMUTU:"
          Write-Host "   xfreerdp /v:$rdpAddress /u:runneradmin /p:Pass123! /cert-ignore"
          Write-Host ""
          Write-Host "ğŸŒ WEB ERIÅIM:"
          Write-Host "   https://$rdpAddress (Cloudflare Access ile)"
          Write-Host "=================================================="

      - name: Keep Session Alive and Monitor
        shell: pwsh
        run: |
          Write-Host "ğŸ• Oturum 6 saat boyunca aÃ§Ä±k tutulacak..."
          Write-Host "â° BaÅŸlangÄ±Ã§: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          
          # Her 10 dakikada durum kontrolÃ¼
          for ($i = 1; $i -le 2160; $i++) {
            Start-Sleep -Seconds 10
            
            if ($i % 60 -eq 0) {  # Her 10 dakikada
              $elapsed = [math]::Round($i / 6, 1)
              Write-Host "â±ï¸ GeÃ§en sÃ¼re: $elapsed dakika"
              
              # Cloudflared job durumunu kontrol et
              $jobs = Get-Job | Where-Object { $_.State -eq 'Running' }
              Write-Host "ğŸ”§ Aktif tunnel sayÄ±sÄ±: $($jobs.Count)"
              
              # Son Ã§Ä±ktÄ±larÄ± gÃ¶ster
              if ($jobs.Count -gt 0) {
                $latestOutput = Receive-Job -Job $jobs[0] -Keep | Select-Object -Last 3
                if ($latestOutput) {
                  Write-Host "ğŸ“Š Son tunnel loglarÄ±:"
                  $latestOutput | ForEach-Object { Write-Host "   $_" }
                }
              }
            }
          }
          
          Write-Host "â° Oturum sÃ¼resi doldu: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"

      - name: Cleanup Tunnel
        if: always()
        shell: pwsh
        env:
          CLOUDFLARE_API_TOKEN: ${{ github.event.inputs.cloudflare_token }}
        run: |
          if ($env:TUNNEL_ID) {
            Write-Host "ğŸ§¹ Tunnel temizleniyor..."
            try {
              & .\cloudflared.exe tunnel delete $env:TUNNEL_ID --force
              Write-Host "âœ… Tunnel silindi"
            } catch {
              Write-Host "âš ï¸ Tunnel silme hatasÄ±: $($_.Exception.Message)"
            }
          }
